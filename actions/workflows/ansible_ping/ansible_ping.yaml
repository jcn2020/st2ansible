---
version: 1.0
description: quick demo of ansible

input:
  - private_keypath
  - inventory_file
  - playbook

vars:
  - results: 'nil'

output:
  - final: <% ctx().results %> 

tasks:
  say_hello:
    action: core.local
    input:
      cmd: "pwd && cd /opt/stackstorm/packs/sre__ansible_automation/artifacts && ls -altr"
      # cmd: "echo 'hello'"
    next:
      - when: <% succeeded() %>
        publish:
          - results: "<% task(say_hello).result %>"
          # - results: "passing"
        do:
          - set_results
      - when: <% failed() %>
        publish:
          - results: "that's all folks" 

  set_results:
    action: core.noop
    next: 
      - when: <% succeeded() %> 
        publish:
          - results: "<% task(say_hello).result %>"
          # - results: "passing #2"
      - when: <% failed() %> 
        publish: 
          - results: "Task failed, no output available"

 run_ansible:
    action: ansible.playbook
    input: 
      private_keypath: <% ctx().private_keypath %>
      inventory_file: <% ctx().inventory_file %>
      playbook: "<% ctx().playbook %>"
    next:
      - when: <% succeeded() %>
        publish:
          - results: "<% task(run_ansible).result %>"
      - when: <% failed() %>
        publish: 
          - results: "Task failed, no output available" 



